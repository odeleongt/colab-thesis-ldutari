---
output:
  html_document: default
---


```{r setup, include=FALSE}
# Load used packages
library(package = "readxl")
library(package = "tidyverse")

# configure ggplot2 theme
theme_set(
  theme_classic() +
    theme(
      title = element_text(face = "bold"),
      plot.subtitle = element_text(face = "plain")
    )
)

# configure knitting
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = "..")
```


```{r data}
# load data
source(file = "scripts/load-data.R")
```


**Last updated:** `r substr(Sys.time(), 1, 19)`

# Statistical analysis

Statistical analysis performed using R v3.4.0 (R Core Team 2017).




# Lutzomyia diversity 2015

## Data description

### Sex of collected specimens

```{r lutzomyia-sex-description}
lutzomyia_sex %>%
  mutate(
    sex = recode(
      sex,
      f = "female",
      m = "male"
    )
  ) %>%
  spread(key = sex, value = total_indivituals) %>%
  set_names(
    gsub("(^| )([a-z])", "\\1\\U\\2", gsub("_", " ", names(.)), perl = TRUE)
  ) %>%
  knitr::kable(
    caption = paste(
      "**Table 1:**",
      "Total individuals collected by species and sex" 
    )
  )
```


### Specimens by site

```{r lutzomyia-site-description}
lutzomyia %>%
  group_by(species, site) %>%
  summarize(
    n = n(),
    mean = mean(count),
    text = paste0(mean, " (", n, ")")
  ) %>%
  select(species, site, text) %>%
  spread(key = site, value = text) %>%
  set_names(
    gsub("(^| )([a-z])", "\\1\\U\\2", gsub("_", " ", names(.)), perl = TRUE)
  ) %>%
  set_names(
    ifelse(names(.) == "Species", names(.), paste0(names(.), ", mean (n)"))
  ) %>%
  knitr::kable(
    caption = paste(
      "**Table 2:**",
      "Mean number of collected individuals by species and forest fragmentation"
    )
  )
```


## Results


### Diversity

```{r prepare-diversity-data}
#------------------------------------------------------------------------------*
# ldutari:
# Indices de diversidad y curvas de acumulacion
# (los indices pueden ser Alpha de Fisher, Margalef, Shannon, Simpson,
# Berger-Parker)
#------------------------------------------------------------------------------*

# All trap order permutations
trap_permutations <- lutzomyia %>%
  # For each site and its traps
  select(site, trap) %>%
  split(.$site) %>%
  map(unique) %>%
  # Calculate all permutations of traps (i.e. simulate order of use)
  map(~combinat::permn(.x$trap)) %>%
  # Put in nice rectangular structure
  map(simplify2array) %>%
  map(t) %>%
  map(as_data_frame) %>%
  # Combine everything
  bind_rows(.id = "site") %>%
  group_by(site) %>%
  mutate(permutation = 1:n()) %>%
  # Use tidy structure
  set_names(gsub("V", "", names(.))) %>%
  gather(key = effort, value = trap, convert = TRUE, -site, -permutation) %>%
  arrange(site, permutation)
```



```{r cummulative-species}
# Cummulative curve using traps as effort
cum_curve_traps <- lutzomyia %>%
  # Number of species by trap
  group_by(site, trap) %>%
  summarize(
    species = sum(count > 0)
  ) %>%
  # Bind with trap permutations
  right_join(trap_permutations) %>%
  # Cummulative species by number of traps
  group_by(site, permutation) %>%
  mutate(
    cum_species = cumsum(species)
  ) %>%
  # Mean number of cummulative species by effort (effort = number of traps)
  group_by(site, effort) %>%
  summarize(
    species_sd = sd(cum_species),
    species_mean = mean(cum_species)
  ) %>%
  ungroup
```



```{r cummulative-curve-traps}
# Plot cummulative curve
cum_curve_traps %>%
  mutate(
    site = gsub("(^| )([a-z])", "\\1\\U\\2", gsub("_", " ", site), perl = TRUE),
    p1sd = species_mean + species_sd,
    m1sd = species_mean - species_sd
  ) %>%
  ggplot(aes(x = effort, y = species_mean, color = site)) +
  geom_line() +
  # geom_line(aes(y = p1sd), linetype = "dashed") +
  # geom_line(aes(y = m1sd), linetype = "dashed") +
  labs(
    title = paste(
      "Figure 1: Cummulative species curve per site",
      "by number of traps.",
      sep = "\n"
    ),
    subtitle = paste(
      "Number of species calculated by averaging the cummulative species",
      "over all permutations of the traps in each site.",
      sep = "\n"
    ),
    x = "Number of traps",
    y = "Number of observed species",
    color = "Site"
  ) +
  coord_fixed(ratio = 1/10)
```



# Lutzomyia diversity 2010-2014

## Data description


## Results

### Species relative abundance between canopy and underbrush

> Pending vertical strata data

```{r vertical-relative-abundance}
#------------------------------------------------------------------------------*
# ldutari:
# Abundancia relative de especies mas abundantes entre dosel y el sotobosque,
# utilizando T-test y U de Mann- Whitney
#------------------------------------------------------------------------------*
```



# References

R Core Team (2017). R: A language and environment for statistical computing. R Foundation for
  Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.
